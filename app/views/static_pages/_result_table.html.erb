<% if !@max_len then @max_len=1000 end%>
<% if @sortby=="p2p" then
   @scoreby="bagged"
 end %>
<% if @scoreby=="activated" then 
   scorefield="activated_count_total"
   elsif @scoreby=="chased" then
   scorefield="chased_count_total"
   else
   scorefield="score"
   @scoreby="bagged" 
end%>

<% if !@sortby then @sortby="park" end%>

<table>
  <tr>
    <th <%=if @scoreby == 'bagged' then 'style=background-color:#33ff22 !important' end%>><%=link_to 'Bagged v','?scoreby=bagged&sortby='+@sortby, remote: true,:onclick => "linkHandler('bagged')"%></th>
    <th <%=if @scoreby == 'activated' then 'style=background-color:#33ff22 !important' end%>><%=link_to 'Activated v','?scoreby=activated&sortby='+@sortby, remote: true,:onclick => "linkHandler('activated')"%></th>
    <th <%=if @scoreby == 'chased' then 'style=background-color:#33ff22 !important' end%>><%=link_to 'Chased v','?scoreby=chased&sortby='+@sortby, remote: true,:onclick => "linkHandler('chased')"%></th>
  </tr>
</table>
  <table>
    <tr>
      <th>Position</th>
      <th>Callsign</th>
      <% AssetType.where("keep_score = true").each do |asset_type| %>
        <th <%=if asset_type.name == @sortby then 'style=background-color:#33ff22 !important' end%>><%=link_to asset_type.display_name+" v", "?scoreby="+@scoreby+"&sortby="+asset_type.name, remote: true, onclick: "linkHandler('default_order')" %></th>
      <% end %>
      <th <%=if 'p2p' == @sortby then 'style=background-color:#33ff22 !important' end%>>
        <span title="Places worked Portable to Portable"><%=link_to 'P2P'+" v", "?scoreby=bagged&sortby=p2p", remote: true, onclick: "linkHandler('default_order')" %></span></th>
      <th <%=if 'qrp' == @sortby then 'style=background-color:#33ff22 !important' end%>>
        <span title="Places worked operating QRP"><%=link_to 'QRP'+" v", "?scoreby="+@scoreby+"&sortby=qrp", remote: true, onclick: "linkHandler('default_order')" %></span></th>
    </tr>

    <% position=0    
    lastscore=99999999 %>
    <% if @users then  @users[0..@max_len].each do |user| %>
      <% if position<@max_len and user[scorefield][@sortby] and user[scorefield][@sortby]>-1 then %>
        <% 
           if (user[scorefield][@sortby]||0)<(lastscore||0) then 
            position+=1
            lastscore=user[scorefield][@sortby]
           end
        %>
        <tr>
          <td>
            <%= position.to_s %>
          </td>
          <td>
            <%= link_to user.callsign.upcase, '/users/'+user.callsign, remote: true, :id => 'user_link_'+user.id.to_s, :style => (if not user.activated then 'color:grey' else '' end), :onclick => "linkHandler('user_link_"+user.id.to_s+"')" %>
          </td>
          <% AssetType.where("keep_score = true").each do |asset_type| %>
            <td><%=(user[scorefield][asset_type.name]||0).to_s%></td>
          <% end %>
          <td><%=(user[scorefield]['p2p']||0).to_s%></td>
          <td><%=(user[scorefield]['qrp']||0).to_s%></td>
        </tr>
      <% end %>
    <% end end  %>
  </table>
</div>
