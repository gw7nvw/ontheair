<script>
  reset_map_controllers();
  document.getElementById("page_status").innerHTML = '';
  document.body.classList.remove('loading');
  document.title = '... On the Air'
  document.getElementById('logo').innerHTML='... On The Air'

  $(function () {
    $('#right_panel .pagination a').on('click', function () {
      $.getScript(this.href);
      return false;
    });
  });
</script>
 
<div id="actionbar" class="span7">
  <div id="crumbs">
    <%=link_to "Home", '/', remote: true,  :id => 'home', :onclick => "linkHandler('home')" %>
    &nbsp;--&gt;&nbsp;
    <b>Contacts</b>
    <% if @whochased then %>&nbsp;--&gt;&nbsp;Who Chased<% end %>
    <% if @user then %>&nbsp;--&gt;&nbsp;<b><%= @user.callsign %></b><% end %>
    <% if @asset then %>&nbsp;--&gt;&nbsp;<b><%= @asset.codename %></b>
      <% elsif @assetcode then %>&nbsp;--&gt;&nbsp;<b><%= @assetcode %></b>
      <% elsif @all then %>&nbsp;--&gt;&nbsp;<b>All</b>
      <% elsif @class then %>&nbsp;--&gt;&nbsp;<b><%= @class.capitalize.pluralize %></b>
      <% elsif @orphans then %>&nbsp;--&gt;&nbsp;<b>Unmatched Contacts</b>
    <% end %>
  </div>
  <div id="controls">
    <% if write_access?  %>
      <% if current_user.is_admin then %>
        <%=  link_to "View All", '/contacts/?user=all', class: "btn btn-small btn-primary", remote: true, :onclick => "linkHandler('all')" %>
      <% end %>
      <%=  link_to "Add Contacts", '/logs/new', class: "btn btn-small btn-primary", remote: true, :onclick => "linkHandler('edit')" %>
    <% end %>
    <% if signed_in? %>
      <%=  link_to "Download", '/contacts.csv?download=true&'+raw(@parameters), class: "btn btn-small btn-primary"%>
    <% end %>
    <%=render 'map_controls'%>
  </div>
</div>

<div id="right_scroll">
  <%= render 'flash' %>
  <% if @orphans==true then%>
    <div class="sectiontitle">
       Unmatched chaser contacts
     </div>
    <div class="erow">
       This page lists contacts logged by others that record you in locations for which
       you have never submitted an activator log. If everyone's logs are correct and 
       up to date then there should be no contacts listed here<br/>
       <ul>
         <li><b>Confirm contact</b> will confirm the contact and create the appropriate activator log</li>
         <li><b>Refute contact</b> will remove an incorrect location for you from the chaser's log</li>
       </ul>
    </div>
  <% else %>
    <%= form_tag '/contacts', :name => 'findform', :remote => true, :method => 'get', :style => 'margin-bottom: 0px' %>
      <br/>
      <% if !@zlota_logs %>
        <div class="erow">
          <div class="rowtitle">Show contacts for (location code):</div>
          <div class="rowtext"> <input type="text" name="asset" value='<%=@assetcode%>'/> </div>
        </div>
        <div class="erow">
          <a href="#" class="link_to" remote=true onclick='expand_div("advanced");return(false);'>Advanced v</a>
        </div>
      <% end %>
      <div id="advanced" <% if !@zlota_logs %>style="display:none"<% end %>>
        <div class="erow">
          <div class="rowtitle">Callsign:</div>
          <div class="rowtext"><input type="text" name="user" value='<%=@callsign%>'/></div>
        </div>
        <% if !@zlota_logs %>
          <div class="erow">
            <div class="rowtitle">Result per page:</div>
            <div class="rowtext"><input type="text" name="pagelen" value='<%=@page_len%>'/></div>
          </div>
        <% end %>
        <div class="erow">
          <div class="rowtitle">Class:</div>
          <div class="rowtext">
            <select name="class" id="class">
              <%for type in AssetType.all%>
                <option value="<%=type.name%>" <%if @class==type.name then%> selected <% end %>><%=type.display_name%></option>
              <%end%>
            </select> 
          </div>
        </div>
        <div class="erow">
          <div class="rowtitle">Activator?:</div>
          <div class="rowtext"><input type="checkbox" name="activator" <% if @activator then %>checked<% end %>/></div>
        </div>
        <div class="erow">
          <div class="rowtitle">Chaser?:</div>
          <div class="rowtext"><input type="checkbox" name="chaser" <% if @chaser then %>checked<% end %>/></div>
        </div>
      </div>
      <input type="hidden" name="zlota_logs" value='<%=@zlota_logs%>'/>
      <div class="erow">
        <div class="buttonshort">
          <%= submit_tag "Filter", :id => "find", :class => "btn btn-small", :onclick => "submitHandler('Finding...');" %>
          <%if !@zlota_logs %><%= link_to "Clear", '/contacts', class: "btn btn-small", remote: true, :onclick => "linkHandler('clear')"%><% end %>
      <% if signed_in? and @fullcontacts %>
        <% if @zlota_logs == true %>
          <%=  link_to "Download Site List", "/users/#{@callsign}/assets.csv?asset_type=#{@class}&count_type=#{@count_type}", class: "btn btn-small btn-primary"%>
        <% end %>
        <%=  link_to "Download Log", '/contacts.csv?download=true&simple=true&'+raw(@parameters), class: "btn btn-small btn-primary"%>
        <%=  link_to "Download Full Log", '/contacts.csv?download=true&'+raw(@parameters), class: "btn btn-small btn-primary"%>
      <% end %>

        </div>
      </div>
    </form>
  <% end %>

  <div class="erow">
    <%= render 'list' %>
  </div>
  
  <div class="erow">Key: <div style="color:green">QRP</div>  <div style="text-decoration:underline">Home Station</div></div>
</div>

<script>
  document.getElementById('actionbar-full').innerHTML=document.getElementById('actionbar').innerHTML;
  <% if @contacts then %>
    <% @contacts.each do |contact| %>
      <% if @user and @user.id==contact.user2_id then
        l2=contact.location1
        l1=contact.location2
      else
        l1=contact.location1
        l2=contact.location2
      end %>
      <% if l1 then %> 
        map_add_feature_from_wkt('<%=l1%>', 'EPSG:4326',site_green_circle);
      <% end %>
      <% if l2 then %>
        map_add_feature_from_wkt('<%=l2%>', 'EPSG:4326',site_red_circle);
      <% end %>
    <% end %>
  <% end %>
</script>
